<div class="model-form-container">
  <div class="page-header">
    <div>
      <h1>{{ isEditMode() ? 'Edit' : 'Create' }} Model</h1>
      <p class="subtitle">Category: {{ category() }}</p>
    </div>
    <button type="button" class="btn btn-secondary" (click)="toggleViewMode()">
      Switch to {{ viewMode() === 'form' ? 'JSON' : 'Form' }} View
    </button>
  </div>

  @if (loading()) {
    <div class="loading-state">Loading model data...</div>
  } @else {
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <div class="form-group name-field">
        <label for="name">
          Model Name *
          @if (isEditMode()) {
            <span class="hint">(read-only in edit mode)</span>
          }
        </label>
        <input
          id="name"
          type="text"
          formControlName="name"
          placeholder="my-model-name"
          [class.error]="form.get('name')?.invalid && form.get('name')?.touched"
        />
        @if (form.get('name')?.hasError('required') && form.get('name')?.touched) {
          <span class="error-message">Model name is required</span>
        }
        @if (form.get('name')?.hasError('pattern') && form.get('name')?.touched) {
          <span class="error-message"
            >Only alphanumeric characters, hyphens, and underscores allowed</span
          >
        }
        @if (!isEditMode()) {
          <span class="help-text">Use lowercase, numbers, hyphens, or underscores</span>
        }
      </div>

      @if (viewMode() === 'form') {
        <div class="form-fields-container">
          <app-common-fields [data]="commonData()" (dataChange)="onCommonDataChange($event)" />

          @if (isImageGeneration()) {
            <app-stable-diffusion-fields
              [data]="stableDiffusionData()"
              (dataChange)="onStableDiffusionDataChange($event)"
            />
          }

          @if (isTextGeneration()) {
            <app-text-generation-fields
              [data]="textGenerationData()"
              (dataChange)="onTextGenerationDataChange($event)"
            />
          }

          @if (isClip()) {
            <app-clip-fields [data]="clipData()" (dataChange)="onClipDataChange($event)" />
          }

          <app-config-form-section
            [config]="configData()"
            (configChange)="onConfigDataChange($event)"
          />
        </div>
      } @else {
        <div class="form-group">
          <label for="jsonData">
            Model Data (JSON) *
            <span class="hint">Name field will be added automatically</span>
          </label>
          <textarea
            id="jsonData"
            formControlName="jsonData"
            rows="20"
            placeholder='{"description": "...", "config": {...}}'
            [class.error]="form.get('jsonData')?.invalid && form.get('jsonData')?.touched"
          ></textarea>
          @if (form.get('jsonData')?.hasError('required') && form.get('jsonData')?.touched) {
            <span class="error-message">Model data is required</span>
          }
          <span class="help-text"
            >Enter valid JSON. Common fields: description, config, baseline, nsfw, etc.</span
          >
        </div>
      }

      @if (validationIssues().length > 0) {
        <div class="validation-panel">
          <h3>Validation Results</h3>

          @if (groupedIssues().errors.length > 0) {
            <div class="validation-section errors">
              <h4>Errors ({{ groupedIssues().errors.length }})</h4>
              <ul>
                @for (issue of groupedIssues().errors; track $index) {
                  <li class="validation-error">
                    @if (issue.field) {
                      <strong>{{ issue.field }}:</strong>
                    }
                    {{ issue.message }}
                  </li>
                }
              </ul>
            </div>
          }

          @if (groupedIssues().warnings.length > 0) {
            <div class="validation-section warnings">
              <h4>Warnings ({{ groupedIssues().warnings.length }})</h4>
              <ul>
                @for (issue of groupedIssues().warnings; track $index) {
                  <li class="validation-warning">
                    @if (issue.field) {
                      <strong>{{ issue.field }}:</strong>
                    }
                    {{ issue.message }}
                  </li>
                }
              </ul>
            </div>
          }

          @if (groupedIssues().errors.length === 0 && groupedIssues().warnings.length === 0) {
            <div class="validation-success">No validation issues found</div>
          }
        </div>
      }

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="cancel()">Cancel</button>
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="submitting() || form.invalid || hasErrors()"
        >
          {{ submitting() ? 'Saving...' : isEditMode() ? 'Update Model' : 'Create Model' }}
        </button>
      </div>
      @if (hasErrors()) {
        <div class="alert alert-error">Please fix validation errors before submitting</div>
      }
      @if (!hasErrors() && groupedIssues().warnings.length > 0) {
        <div class="alert alert-warning">
          You have {{ groupedIssues().warnings.length }} warning(s), but you can still submit
        </div>
      }
    </form>
  }
</div>
