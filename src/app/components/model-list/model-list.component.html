<div class="p-4 space-y-4">
  <!-- Page Header -->
  <div class="card">
    <div class="flex justify-between items-start px-6 py-4">
      <div>
        <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100">
          {{ recordDisplayMap[category()] || category() }}
        </h1>
        <div class="text-xs text-gray-400 dark:text-gray-500 font-mono mt-0.5">
          MODEL_REFERENCE_CATEGORY: {{ category() }}
        </div>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
          {{ totalModels() }} models
          @if (filteredModels().length !== totalModels()) {
            (showing {{ filteredModels().length }} after filters)
          }
        </p>

        <!-- Category Statistics -->
        @if (filteredModels().length > 0) {
          <div class="flex flex-wrap gap-3 mt-3">
            @for (statType of categoryStatsConfig(); track statType) {
              @if (statType === 'baseline' && baselineStats().length > 0) {
                <div
                  class="stat-card stat-card--column"
                  title="Click for detailed baseline breakdown"
                  tabindex="0"
                  role="button"
                  (click)="showBaselineDetails()"
                  (keydown)="
                    ($event.key === 'Enter' || $event.key === ' ') && showBaselineDetails()
                  "
                >
                  <span class="stat-card-label">Baselines</span>
                  <div class="stat-card-badges">
                    @for (stat of baselineStats(); track stat.baseline) {
                      <span class="badge badge-info" [title]="getBaselineTooltip(stat.baseline)">
                        {{ getBaselineDisplayName(stat.baseline) }}: {{ stat.count }}
                      </span>
                    }
                  </div>
                </div>
              }
              @if (statType === 'tags' && tagStats() > 0) {
                <div
                  class="stat-card"
                  title="Click to see all tags"
                  tabindex="0"
                  role="button"
                  (click)="showTagsDetails()"
                  (keydown)="($event.key === 'Enter' || $event.key === ' ') && showTagsDetails()"
                >
                  <span class="badge badge-info">
                    {{ tagStats() }} tag{{ tagStats() === 1 ? '' : 's' }}
                  </span>
                </div>
              }
              @if (statType === 'nsfw') {
                <div
                  class="stat-card stat-card--column"
                  role="button"
                  tabindex="0"
                  title="Click for content rating details"
                  (click)="showNsfwDetails()"
                  (keydown)="($event.key === 'Enter' || $event.key === ' ') && showNsfwDetails()"
                >
                  <span class="stat-card-label">Content Rating</span>
                  <div class="stat-card-badges">
                    @if (nsfwStats().nsfw > 0) {
                      <span class="badge badge-warning"> NSFW: {{ nsfwStats().nsfw }} </span>
                    }
                    @if (nsfwStats().sfw > 0) {
                      <span class="badge badge-success"> SFW: {{ nsfwStats().sfw }} </span>
                    }
                    @if (nsfwStats().unknown > 0) {
                      <span class="badge badge-secondary">
                        Unknown: {{ nsfwStats().unknown }}
                      </span>
                    }
                  </div>
                </div>
              }
              @if (statType === 'size' && sizeStats() > 0) {
                <div
                  class="stat-card"
                  role="button"
                  tabindex="0"
                  title="Click for disk size details"
                  (click)="showSizeDetails()"
                  (keydown)="($event.key === 'Enter' || $event.key === ' ') && showSizeDetails()"
                >
                  <span class="badge badge-info"> {{ formatSizeInGB(sizeStats()) }} GB total </span>
                </div>
              }
              @if (statType === 'parameters') {
                <div
                  class="stat-card stat-card--column"
                  role="button"
                  tabindex="0"
                  title="Click for detailed parameter breakdown"
                  (click)="showParametersDetails()"
                  (keydown)="
                    ($event.key === 'Enter' || $event.key === ' ') && showParametersDetails()
                  "
                >
                  <span class="stat-card-label">Parameters</span>
                  <div class="stat-card-badges">
                    @for (bucket of parameterBucketStats().topBuckets; track bucket.params) {
                      <span class="badge badge-info">
                        {{ bucket.count }}x [{{ formatParametersInBillions(bucket.params) }}]
                      </span>
                    }
                    @if (parameterBucketStats().otherCount > 0) {
                      <span class="badge badge-secondary">
                        {{ parameterBucketStats().otherCount }} other{{
                          parameterBucketStats().otherCount === 1 ? '' : 's'
                        }}
                      </span>
                    }
                  </div>
                </div>
              }
              @if (statType === 'requirements' && requirementsStats() > 0) {
                <div
                  class="stat-card"
                  title="Click to see model requirements"
                  tabindex="0"
                  role="button"
                  (click)="showRequirementsDetails()"
                  (keydown)="
                    ($event.key === 'Enter' || $event.key === ' ') && showRequirementsDetails()
                  "
                >
                  <span class="badge badge-info">
                    {{ requirementsStats() }} model{{
                      requirementsStats() === 1 ? '' : 's'
                    }}
                    with requirements
                  </span>
                </div>
              }
              @if (statType === 'style' && styleStats().length > 0) {
                <div
                  class="stat-card stat-card--column"
                  title="Click for detailed style breakdown"
                  tabindex="0"
                  role="button"
                  (click)="showStyleDetails()"
                  (keydown)="
                    ($event.key === 'Enter' || $event.key === ' ') && showStyleDetails()
                  "
                >
                  <span class="stat-card-label">Styles</span>
                  <div class="stat-card-badges">
                    @for (stat of styleStats(); track stat.style) {
                      <span class="badge badge-info">
                        {{ stat.style }}: {{ stat.count }}
                      </span>
                    }
                  </div>
                </div>
              }
            }
          </div>
        }

        @if (writable()) {
          <button class="btn btn-primary mt-2" (click)="createModel()">+ Create Model</button>
        }
      </div>
    </div>
  </div>

  <!-- Search and Toggle -->
  <div
    class="sticky top-0 z-40 flex gap-4 items-end bg-gray-50 dark:bg-gray-900 pt-2 pb-4 -mx-4 px-4 shadow-md before:absolute before:inset-x-0 before:bottom-full before:h-4 before:bg-gray-50 dark:before:bg-gray-900"
  >
    <div>
      <label for="model-search" class="form-label">Search models</label>
      <input
        id="model-search"
        type="search"
        class="form-input w-64 text-gray-400"
        placeholder="Enter a name, description, or tag"
        [(ngModel)]="searchTerm"
        (ngModelChange)="searchTerm.set($event)"
      />
    </div>
    <div class="relative">
      <label class="form-label" for="tag-filter-btn">Filter by tags</label>
      <button
        id="tag-filter-btn"
        type="button"
        class="form-input w-64 text-left flex items-center justify-between"
        (click)="toggleTagFilterDropdown()"
      >
        <span class="truncate">
          @if (selectedTags().length === 0) {
            All tags
          } @else {
            {{ selectedTags().length }} tag(s) selected
          }
        </span>
        <svg
          class="w-4 h-4 ml-2 flex-shrink-0"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M19 9l-7 7-7-7"
          ></path>
        </svg>
      </button>

      @if (tagFilterOpen()) {
        <!-- Backdrop to close dropdown when clicking outside -->
        <div
          class="fixed inset-0 z-40"
          tabindex="0"
          (click)="closeTagFilterDropdown()"
          (keydown)="($event.key === 'Enter' || $event.key === ' ') && closeTagFilterDropdown()"
          aria-label="Close tag filter dropdown"
        ></div>

        <div
          class="absolute z-50 mt-1 w-64 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-64 overflow-y-auto"
        >
          <div
            class="p-2 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center"
          >
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Select tags</span>
            @if (selectedTags().length > 0) {
              <button type="button" class="text-xs link" (click)="clearAllTags()">Clear all</button>
            }
          </div>
          <div class="p-2">
            @if (availableTags().length === 0) {
              <div class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">
                No tags available
              </div>
            } @else {
              @for (tag of availableTags(); track tag) {
                <label
                  class="flex items-center px-2 py-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer"
                >
                  <input
                    type="checkbox"
                    class="w-4 h-4 text-primary-600 border-gray-300 dark:border-gray-600 rounded focus:ring-primary-500"
                    [checked]="isTagSelected(tag)"
                    (change)="toggleTag(tag)"
                  />
                  <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">{{ tag }}</span>
                </label>
              }
            }
          </div>
        </div>
      }
    </div>
    <label class="flex items-center gap-2 cursor-pointer select-none">
      <input
        type="checkbox"
        class="sr-only peer"
        [checked]="showDetails()"
        (change)="toggleShowDetails()"
        aria-checked="{{ showDetails() ? 'true' : 'false' }}"
        role="switch"
      />
      <span
        class="w-11 h-6 bg-gray-300 dark:bg-gray-700 rounded-full relative transition-colors duration-200 peer-checked:bg-primary-600 dark:peer-checked:bg-primary-400"
      >
        <span
          class="absolute top-1 left-1 w-4 h-4 bg-white dark:bg-gray-900 rounded-full shadow transition-transform duration-200"
          [class.translate-x-5]="showDetails()"
        ></span>
      </span>
      <span class="text-sm font-medium text-gray-700 dark:text-gray-200">
        {{ showDetails() ? 'Hide Details' : 'Show Details' }}
      </span>
    </label>
  </div>

  <!-- Loading/Empty States -->
  @if (loading()) {
    <div class="card">
      <div class="text-center py-12 text-gray-500 dark:text-gray-400">Loading models...</div>
    </div>
  } @else if (filteredModels().length === 0) {
    <div class="card">
      <div class="text-center py-12 text-gray-500 dark:text-gray-400">
        @if (searchTerm()) {
          No models match your search
        } @else {
          No models in this category
        }
      </div>
    </div>
  } @else {
    <!-- Data Table -->
    <div class="data-table">
      <table>
        <thead>
          <tr>
            <th class="w-8"></th>
            <th class="w-auto">Name</th>
            <th class="w-1/3">Description</th>
            <th>Baseline</th>
            <th>Tags</th>
            <th>NSFW</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (model of filteredModels(); track model.name; let isEven = $even) {
            <app-model-row
              [model]="model"
              [writable]="writable()"
              [isEven]="isEven"
              [expandedRows]="expandedModels()"
              [expandedShowcases]="expandedShowcases()"
              (showJson)="showJson($event)"
              (edit)="editModel($event)"
              (delete)="confirmDelete($event)"
              (toggleRow)="toggleRowExpansion($event)"
            />
          }
        </tbody>
      </table>
    </div>
  }
</div>

<!-- Delete Confirmation Modal -->
@if (modelToDelete()) {
  <div
    class="modal-overlay"
    tabindex="0"
    (click)="cancelDelete()"
    (keydown)="($event.key === 'Enter' || $event.key === ' ') && cancelDelete()"
    aria-label="Close modal"
  >
    <div
      class="modal-dialog"
      tabindex="0"
      (click)="$event.stopPropagation()"
      (keydown)="($event.key === 'Enter' || $event.key === ' ') && $event.stopPropagation()"
      aria-modal="true"
      role="dialog"
    >
      <h2 class="modal-title">Confirm Delete</h2>
      <div class="modal-content space-y-3">
        <p>
          Are you sure you want to delete <strong>{{ modelToDelete() }}</strong
          >?
        </p>
        <p class="text-danger-600 dark:text-danger-400 font-medium">
          This action cannot be undone.
        </p>
        <div>
          <label for="delete-confirm" class="form-label">Type the model name to confirm:</label>
          <input
            id="delete-confirm"
            type="text"
            class="form-input"
            placeholder="{{ modelToDelete() }}"
            [(ngModel)]="deleteConfirmationInput"
            (ngModelChange)="deleteConfirmationInput.set($event)"
            autocomplete="off"
          />
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" (click)="cancelDelete()">Cancel</button>
        <button
          class="btn btn-danger"
          [disabled]="!deleteAllowed()"
          (click)="deleteModel(modelToDelete()!)"
        >
          Delete
        </button>
      </div>
    </div>
  </div>
}

<!-- JSON Display Modal -->
@if (modelJsonToShow()) {
  <div
    class="modal-overlay"
    tabindex="0"
    (click)="closeJsonModal()"
    (keydown)="($event.key === 'Enter' || $event.key === ' ') && closeJsonModal()"
    aria-label="Close modal"
  >
    <div
      class="modal-dialog modal-dialog--xl"
      tabindex="0"
      (click)="$event.stopPropagation()"
      (keydown)="($event.key === 'Enter' || $event.key === ' ') && $event.stopPropagation()"
      aria-modal="true"
      role="dialog"
    >
      <h2 class="modal-title">Model JSON: {{ modelJsonToShow()!.name }}</h2>
      <div class="modal-content">
        <pre
          class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg overflow-x-auto text-sm"
        ><code>{{ getFormattedJson(modelJsonToShow()!) }}</code></pre>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" (click)="copyJsonToClipboard(modelJsonToShow()!)">
          Copy
        </button>
        <button class="btn btn-primary" (click)="closeJsonModal()">Close</button>
      </div>
    </div>
  </div>
}

<!-- Stat Details Modal -->
@if (statDetailsToShow()) {
  <div
    class="modal-overlay"
    tabindex="0"
    (click)="closeStatDetails()"
    (keydown)="($event.key === 'Enter' || $event.key === ' ') && closeStatDetails()"
    aria-label="Close modal"
  >
    <div
      class="modal-dialog"
      tabindex="0"
      (click)="$event.stopPropagation()"
      (keydown)="($event.key === 'Enter' || $event.key === ' ') && $event.stopPropagation()"
      aria-modal="true"
      role="dialog"
    >
      <h2 class="modal-title">{{ statDetailsToShow()!.title }}</h2>
      <div class="modal-content">
        <pre
          class="bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 p-4 rounded-lg overflow-x-auto text-sm whitespace-pre-wrap break-words"
          >{{ statDetailsToShow()!.content }}</pre
        >
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" (click)="copyStatDetailsToClipboard()">Copy</button>
        <button class="btn btn-primary" (click)="closeStatDetails()">Close</button>
      </div>
    </div>
  </div>
}
